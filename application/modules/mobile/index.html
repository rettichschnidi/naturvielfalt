<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Naturvielfalt</title>
<link rel="stylesheet" href="baseline/uncompressed/baseline.reset.css">
<link rel="stylesheet" href="baseline/uncompressed/baseline.base.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<link rel="apple-touch-icon-precomposed" href="images/icon.png" />
<link rel="apple-touch-startup-image" href="images/spash.png" />
<style>
body {
    margin: 0;
    font-size: 100%;
    background-image: url("images/bar.png");
    background-repeat: no-repeat;
    background-size: 320px 52px;
    cursor: default;
}

p+p {
    text-indent: 0;
}

input {
    font-size: 1em;
}

.wrapper {
    width: 320px;
    overflow: hidden;
}

.container {
    position: relative;
    width: 960px;
    height: 100%;
    -webkit-transform: translate3d(0,0,0);
    -webkit-backface-visibility: hidden;
}

header {
    height: 52px;
    color: #fff;
    line-height: 30px;
    -webkit-transform: translate3d(0,0,0);
    -webkit-backface-visibility: hidden;
}

header h2 {
    display: inline-block;
    font-weight: normal;
    text-align: center;
    width: 138px;
    padding: 0 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: -1px;
    text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.4);
}

#content header h2 {
    font-size: 0.9em;
    text-align: left;
    line-height: 2;
}

#content header {
    padding: 14px 10px 0 10px;
    height: 38px; // 52 - 14
}

header a {
    font-size: 0.8em;
    text-decoration: none;
    color: #fff;
    display: inline-block;
    padding: 11px 12px 10px 8px;
    background-image: url("images/button.png");
    background-repeat: no-repeat;
    background-size: 75px 104px;
    line-height: 34px;
    text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.6);
}

header a:hover {
    background-position: 0 -52px;
}

header a.back {
    padding: 11px 12px 10px 26px;
    background-image: url("images/back.png");
    background-size: 77px 104px;
    background-position: 2px 0;
}

header a.back:hover {
    background-position: 2px -52px;
}

body header .icon {
}

.content {
    position: relative;
    width: 320px;
    top: 0;
    left: 0;
}

.inner {
    -webkit-overflow-scrolling: touch;
    overflow: auto;
    background-color: #fff;
}

#second {
    position: absolute;
    left: 320px;
    top: 0px;
}

#third {
    position: absolute;
    left: 640px;
    top: 0px;
}

.content ul {
    margin: 0;
    -webkit-user-select: none;
}

.content li {
    list-style-type: none;
    border-bottom: 1px dotted #ccc;
}

.content li a {
    display: block;
    padding: 10px 10px 11px;
    text-decoration: none;
    color: #000;
    -webkit-tap-highlight-color:rgba(0,0,0,0);
    background-image: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.content li a.active {
    background-image: -webkit-gradient(linear,left top,left bottom,from(#058cf5),to(#015de6));
    color: white;
}

.content li:last-child {
    border-bottom: 0;
}

.inner h3 {
    padding: 15px 10px;
    font-weight: bold;
}

.inner p {
    padding: 10px;
}

.inner p.input {
    border-bottom: 1px dotted #ccc;
}

.inner p label {
    display: inline-block;
    width: 80px;
    padding-right: 10px;
}

.inner p input[type=submit] {
    margin-left: 90px;
}

#map {
    background-image: url("images/loading.gif");
    background-repeat: no-repeat;
    background-position: center;
    background-size: 16px 16px;
    line-height: 1;
}

#organism {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: inline-block;
    width: 210px;
}

</style>
<script src="zepto/zepto.min.js"></script>
<script>

var lat, lon;
function updateLocation(position) {
    if (lat != position.coords.latitude || lon != position.coords.longitude) {
        lat = position.coords.latitude;
        lon = position.coords.longitude;
        $('#location').val(lat + ', ' + lon);
    }
}

function updateMap() {
    if (lat && lon) {
        $('#map img').attr('src', 'http://maps.google.com/maps/api/staticmap?style=feature:road|element:labels|visibility:off&zoom=13&size=320x150&scale=2&markers='+lat+','+lon+'&sensor=true');
    }
}

function handleError(error) {
    console.log(error);
}

function scroll(from, to, i) {
    $('.container').anim({translate: (-i * 320) + 'px, 0'}, 0.5, '', function () {
        $('.active').removeClass('active');
    });
    $(from + ' header').anim({opacity: 0}, 0.3);
    $(to + ' header').anim({opacity: 1});
}

function pad(n){
    return n < 10 ? '0' + n : n;
}

var current;
$(function () {

    $('.inner').css('height', (document.height - 52) + 'px');

    // set current date
    var now = new Date();
    $('#date').val(now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate())); 

    var touch = {target: false, moved: false, down: false};
    $(document.body).bind('touchstart', function(e) {
        touch.target = $(e.touches[0].target);
        touch.down = true;
        setTimeout(function () {
            if (touch.down && !touch.moved) {
                touch.target.addClass('active');
            }
        }, 100);
    });
    $(document.body).bind('touchmove', function(e) {
        touch.moved = true;
        $('.active').removeClass('active');
    });
    $(document.body).bind('touchend', function(e) {
        if (!touch.moved) {
            e.preventDefault();
            touch.target.addClass('active');
            
            // timeout to prevent slide before active background is set
            setTimeout(function () {
                touch.target.trigger('click');
            }, 10);
        }
        touch.moved = false;
        touch.down = false;
    });

    $('#save').bind('click', function (e) {

    	var data = {};

        data.organism = $('#id').val();
        data.count = $('#count').val();
        data.date = $('#date').val();
        data.location = $('#location').val();

    	$.ajax({type: 'POST', url: 'ajax.php', data: data, success: function (data) {
    		if (data) { // needed for iOS
	            alert(data);
	            scroll('#third', '#content', 0);
	            $('.active').removeClass('active');
    		}
        }, error: function (xhr, type) {
        	alert(xhr.responseText);
        }});
    });

    $('#second header a.back').bind('click', function (e) {
        scroll('#second', '#content', 0);
        $('.active').removeClass('active');
    });
    $('#third header a.back').bind('click', function (e) {
        scroll('#third', '#second', 1);
    });
    
    if (navigator.geolocation) {
        // Register for location changes and pass the returned position to the updateLocation method
        watchId = navigator.geolocation.watchPosition(updateLocation, handleError);
        navigator.geolocation.getCurrentPosition(updateLocation, handleError);
    }
});

function init() {

    for (var i in db.classes) {
        $('#classes').append('<li><a data="' + i + '">' + db.classes[i] + '</a></li>');
    };

    $('#content a').bind('click', function (e) {

        // clear organisms
        $('#organisms').text('');

        // build organisms
        current = $(e.target).attr('data');
        $('#class').text(db.classes[current]);

        for (var i in db.organisms[current]) {
        	var organism = db.organisms[current][i];
            $('#organisms').append('<li><a data="' + i + '">' + (organism.de) + '</a></li>');
        }

        $('#second ul a').bind('click', function (e) {
            $(e.target).addClass('active');

            // update organism name
            var id = $(e.target).attr('data');
            $('#id').val(id);
            $('#organism').text(db.organisms[current][id].de);

            // update map with fresh coordinates
            updateMap();

            scroll('#second', '#third', 2);
        });

        scroll('#content', '#second', 1);
    });
}


var db = {
    classes: {
    },
    organisms: {
    }
};


$.getJSON('data.php', function (data) {
    db = data;
    init();
});

</script>
</head>
<body>
<div class="wrapper">
<div class="container">
    <section class="content" id="content">
        <header>
            <img src="images/logo.png" alt="Naturvielfalt" width="112" height="16" />
            <h2>Einzelbeobachtung</h2>
        </header>
        <div class="inner">
	        <ul id="classes">
	        </ul>
        </div>
    </section>

    <section class="content" id="second">
        <header>
            <a class="back">Zurück</a>
            <h2 id="class">Insekten</h2>
        </header>
        <div class="inner">
	        <ul id="organisms">
	        </ul>
        </div>
    </section>

    <section class="content" id="third">
        <header>
            <a class="back">Zurück</a>
            <h2>Beobachtung</h2>
            <a id="save">Speichern</a>
        </header>
        <div class="inner">
	        <div id="map"><img src="http://maps.google.com/maps/api/staticmap?zoom=13&amp;size=320x150&amp;scale=2&amp;markers=47.48123591999999,8.20960172764706&amp;sensor=false" width="320" height="150" /></div>
	        <p class="input"><label for="date">Name: </label><span id="organism"></span></p>
	        <p class="input"><label for="date">Datum: </label><input id="date" type="date" value="2011-07-28" /></p>
	        <p><label for="count">Anzahl: </label><input id="count" type="number" min="1" step="1" value="1" size="4" /></p>
            <input id="location" type="hidden" value="" /><input id="id" type="hidden" value="" />
        </div>
    </section>
</div>
</div>
</body>
</html>
