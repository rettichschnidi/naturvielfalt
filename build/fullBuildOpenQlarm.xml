<?xml version="1.0"?>

<!-- 
	This is an ant build file which makes it easy to build and deloy the application to the apache
	server on www.openqlarm.org.
	
	You can start the script by running one of the following "external tool launch configuration":
	1. Full build for www.openqlarm.org
		Makes a full build and puts those files to build/fullBuildOpenQlarm
	2. Full build and deploy for www.openqlarm.org
		Makes a full build and transfers the files to openqlarm.org. They are created with a timestamp
		suffix. So go to the apache directory and rename them in order to finish the deployment.
	
	To get even more comfort you can pass the arguments DBUsername, DBPassword and ServerUser as java arguments.
	This looks finally like this:
	ant -f fullBuildOpenQlarm.xml -DDBUsername=swissmon -DDBPassword=password -DServerUser=mzimmerli buildAndDeploy
	Last but not least you may want to publish your public key to the server to even avoid the ssh
	password box.
-->

<project name="full build for openqlarm.org" default="build" basedir=".">

	<!-- Clean the target directory -->
	<target name="init">
		<tstamp>
			<format property="timestamp" pattern="yyyyMMdd_hhmmss" locale="de,CH" />
		</tstamp>
		<property name="src" value="../" />
		<property name="build" value="fullBuildOpenQlarm" />
		<property name="buildApplication" value="${build}/application${timestamp}" />
		<property name="buildInventoryServer" value="${build}/inventoryServer${timestamp}" />
		<delete dir="${build}" />
		<mkdir dir="${buildApplication}" />
		<mkdir dir="${buildInventoryServer}" />
	</target>


	<!-- Copy all files into the build directory -->
	<target name="build" depends="init">

		<!-- Get postgreSQL username and password -->
		<input message="Please enter the postgreSQL username:" addproperty="DBUsername" />
		<input message="Please enter the postgreSQL password:" addproperty="DBPassword" />

		<!-- Copy files -->
		<copy todir="${buildApplication}">
			<fileset dir="${src}/application">
				<exclude name="**/.svn" />
				<exclude name="**/.project" />
			</fileset>
		</copy>
		<copy todir="${buildInventoryServer}">
			<fileset dir="${src}/inventoryServer">
				<exclude name="**/.svn" />
				<exclude name="**/.project" />
			</fileset>
		</copy>

		<!-- Modify configurations and .htaccess -->
		<echo message="modify ${buildInventoryServer}/web_root/application/configs/application.ini..." />
		<replace file="${buildInventoryServer}/web_root/application/configs/application.ini" token='resources.db.params.username = "postgres"'
			value='resources.db.params.username = "${DBUsername}"' summary="yes" />
		<replace file="${buildInventoryServer}/web_root/application/configs/application.ini" token='resources.db.params.password = "postgres"'
			value='resources.db.params.password = "${DBPassword}"' summary="yes" />

		<echo message="modify ${buildApplication}/sites/default/settings.php..." />
		<replace file="${buildApplication}/sites/default/settings.php" token="'username' => 'postgres'," value="'username' => '${DBUsername}',"
			summary="yes" />
		<replace file="${buildApplication}/sites/default/settings.php" token="'password' => 'postgres'," value="'password' => '${DBPassword}',"
			summary="yes" />

		<echo message="modify ${buildApplication}.htaccess..." />
		<replace file="${buildApplication}/.htaccess" token="# RewriteBase # --> do not delete!" value="RewriteBase /drupal/application"
			summary="yes" />

		<echo message="modify ${buildInventoryServer}/web_root/.htaccess" />
		<replace file="${buildInventoryServer}/web_root/.htaccess" token="# RewriteBase # --> do not delete!"
			value="RewriteBase /drupal/inventoryServer/web_root" summary="yes" />

		<echo message="modify ${buildInventoryServer}/web_root/public/.htaccess" />
		<replace file="${buildInventoryServer}/web_root/public/.htaccess" token="# RewriteBase # --> do not delete!"
			value="RewriteBase /drupal/inventoryServer/web_root/public" summary="yes" />
	</target>

	<!-- Builds and deploys the application to openqlarm.org -->
	<target name="buildAndDeploy" depends="build">
		<!-- Copy files to server -->
		<echo message="This will copy the build to the openqlarm server. Please be patient and wait until the task has finished." />
		<input message="Please enter username for accessing openqlarm.org:" addproperty="ServerUser" />
		<exec executable="scp">
			<arg value="-r" />
			<arg value="${buildApplication}" />
			<arg value="${ServerUser}@openqlarm.org:/srv/www/htdocs/drupal" />
		</exec>
		<exec executable="scp">
			<arg value="-r" />
			<arg value="${buildInventoryServer}" />
			<arg value="${ServerUser}@openqlarm.org:/srv/www/htdocs/drupal" />
		</exec>
		<echo
			message="Files are copied to openqlarm.org. They are named with a timestamp suffix. So go to the server and rename them to finish the deployment" />
	</target>
</project>